# 故障排查指南

## ❌ 问题：提示"使用本地分析"

如果输入文案后提示"使用本地分析"，说明大模型调用失败了。请按以下步骤排查：

---

## 🔍 排查步骤

### 1. 检查云开发环境ID配置 ⭐⭐⭐

**问题**：`utils/config.js` 中的云开发环境ID可能没有配置

**检查位置**：`utils/config.js` 第 18 行

```javascript
cloud: {
  env: "your-cloud-env-id", // ⬅️ 这里必须填入实际的云开发环境ID
  functionName: "emotionAnalysis",
}
```

**解决方法**：
1. 在微信开发者工具中，点击顶部菜单 **云开发**
2. 查看你的**环境ID**（Environment ID）
3. 将环境ID填入 `utils/config.js` 中
4. 同时检查 `app.js` 中的环境ID是否一致

**示例**：
```javascript
cloud: {
  env: "cloud1-xxxxx", // 你的实际环境ID
  functionName: "emotionAnalysis",
}
```

---

### 2. 检查云函数是否已部署 ⭐⭐⭐

**问题**：云函数可能没有部署或部署失败

**检查方法**：
1. 在微信开发者工具中，点击 **云开发** → **云函数**
2. 查看是否有 `emotionAnalysis` 云函数
3. 检查云函数状态是否为"正常"

**解决方法**：
1. 右键 `cloudfunctions/emotionAnalysis` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成（查看控制台输出）
4. 确认部署成功

---

### 3. 检查API Key配置 ⭐⭐

**问题**：云函数中的API Key可能没有配置或配置错误

**检查位置**：`cloudfunctions/emotionAnalysis/index.js` 第 22 行

```javascript
apiKey: "sk-xxxxxxxxxxxxx", // ⬅️ 确保这里填入了你的百炼平台API Key
```

**解决方法**：
1. 确认API Key已正确填入
2. 确认API Key格式正确（通常以 `sk-` 开头）
3. 确认API Key有效（可以在百炼平台测试）

---

### 4. 查看控制台错误信息 ⭐⭐

**问题**：可能有具体的错误信息

**检查方法**：
1. 在微信开发者工具中，打开 **调试器** → **Console**
2. 输入文案并点击"我说完了"
3. 查看控制台输出的错误信息

**常见错误**：
- `云函数未部署` → 需要部署云函数
- `云开发未初始化` → 检查环境ID配置
- `API Key无效` → 检查API Key
- `网络请求失败` → 检查网络连接

---

### 5. 检查云开发是否开通 ⭐

**问题**：可能没有开通云开发

**检查方法**：
1. 在微信开发者工具中，点击顶部菜单 **云开发**
2. 如果提示需要开通，点击开通

**解决方法**：
1. 开通云开发环境
2. 选择套餐（有免费额度）
3. 记录环境ID并配置到代码中

---

### 6. 检查基础库版本 ⭐

**问题**：基础库版本可能过低

**检查方法**：
1. 在微信开发者工具中，点击 **详情** → **本地设置**
2. 查看 **调试基础库版本**

**解决方法**：
- 确保基础库版本 ≥ 2.2.3
- 在 `app.json` 中可以设置最低版本：
```json
{
  "libVersion": "2.19.4"
}
```

---

## 🔧 快速诊断清单

按顺序检查以下项目：

- [ ] **云开发环境ID已配置**（`utils/config.js` 和 `app.js`）
- [ ] **云函数已部署**（在云开发控制台查看）
- [ ] **API Key已填入**（`cloudfunctions/emotionAnalysis/index.js`）
- [ ] **云开发已开通**（在微信开发者工具中查看）
- [ ] **基础库版本 ≥ 2.2.3**（在详情中查看）
- [ ] **网络连接正常**（可以访问其他网络功能）

---

## 🐛 常见错误及解决方案

### 错误1：`云函数未部署`

**原因**：云函数没有上传到云端

**解决**：
1. 右键 `cloudfunctions/emotionAnalysis` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成

---

### 错误2：`云开发未初始化`

**原因**：环境ID配置错误或未配置

**解决**：
1. 检查 `utils/config.js` 中的 `cloud.env`
2. 检查 `app.js` 中的 `wx.cloud.init()` 环境ID
3. 确保两个地方的环境ID一致且正确

---

### 错误3：`API Key无效`

**原因**：API Key配置错误或已过期

**解决**：
1. 检查 `cloudfunctions/emotionAnalysis/index.js` 中的 API Key
2. 在百炼平台验证 API Key 是否有效
3. 重新生成 API Key 并更新

---

### 错误4：`网络请求失败`

**原因**：网络问题或API服务异常

**解决**：
1. 检查网络连接
2. 检查百炼平台服务状态
3. 稍后重试

---

## 📝 调试技巧

### 1. 查看详细错误信息

在 `pages/index/index.js` 的 catch 块中，错误信息会输出到控制台：
```javascript
console.error('情绪分析失败:', error)
console.error('大模型调用失败详情:', errorMsg)
```

### 2. 查看云函数日志

1. 在微信开发者工具中，点击 **云开发** → **云函数**
2. 点击 `emotionAnalysis` 云函数
3. 查看 **日志** 标签页
4. 查看错误信息

### 3. 测试云函数

可以在云开发控制台直接测试云函数：
1. 点击云函数名称
2. 点击 **测试** 标签
3. 输入测试数据：
```json
{
  "text": "最近感觉很累"
}
```
4. 查看返回结果

---

## ✅ 验证配置

配置完成后，验证步骤：

1. **检查配置文件**
   - [ ] `utils/config.js` 中环境ID已配置
   - [ ] `app.js` 中环境ID已配置
   - [ ] `cloudfunctions/emotionAnalysis/index.js` 中API Key已配置

2. **检查云开发**
   - [ ] 云开发已开通
   - [ ] 云函数已部署
   - [ ] 云函数状态正常

3. **测试功能**
   - [ ] 在小程序中输入文案
   - [ ] 点击"我说完了"
   - [ ] 查看是否成功调用大模型（不显示"使用本地分析"）

---

## 💡 如果还是不行

1. **查看完整错误日志**
   - 打开控制台查看详细错误
   - 查看云函数日志

2. **检查代码版本**
   - 确保代码已保存
   - 确保云函数已重新部署

3. **尝试重启**
   - 重启微信开发者工具
   - 重新编译小程序

4. **联系支持**
   - 提供错误日志
   - 提供配置截图

---

## 🎯 最可能的原因

根据经验，90%的问题都是：

1. **云开发环境ID没有配置** ⭐⭐⭐
2. **云函数没有部署** ⭐⭐
3. **API Key没有配置** ⭐

请优先检查这三个问题！

