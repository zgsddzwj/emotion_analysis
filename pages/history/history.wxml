<view class="history-container">
  <view class="history-content">
    <!-- 搜索 -->
    <view class="filter-section">
      <view class="search-box">
        <input
          class="search-input"
          placeholder="搜索关键词或原因"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          confirm-type="search"
        />
      </view>
    </view>

    <!-- 趋势提示 -->
    <view class="trend-section" wx:if="{{trendText}}">
      <text class="trend-text">{{trendText}}</text>
      <text class="trend-direction" wx:if="{{trendStats.trendDirection}}">{{trendStats.trendDirection}}</text>
    </view>

    <!-- 情绪统计 -->
    <view class="stats-section" wx:if="{{trendStats && trendStats.topEmotions.length > 0}}" bindtap="viewAllEmotions">
      <view class="stats-title">情绪分布</view>
      <view class="stats-list">
        <view class="stat-item" wx:for="{{trendStats.topEmotions}}" wx:key="label">
          <view class="stat-label">{{item.label}}</view>
          <view class="stat-bar">
            <view class="stat-bar-fill" style="width: {{item.percentage}}%"></view>
          </view>
          <view class="stat-count">{{item.count}}次</view>
        </view>
      </view>
      <view class="stats-hint">
        <text class="hint-text">点击查看全部情绪分布 →</text>
      </view>
    </view>

    <!-- 记录列表 -->
    <view class="records-section">
      <view class="record-item" wx:for="{{records}}" wx:key="timestamp" bindtap="viewDetail" data-index="{{index}}">
        <view class="record-header">
          <view class="record-time-info">
            <text class="record-date">{{item.date}}</text>
            <text class="record-time" wx:if="{{item.time}}">{{item.time}}</text>
          </view>
          <view class="record-emotions">
            <view class="record-emotion-tag" wx:for="{{item.analysis ? item.analysis.emotions : item.emotions}}" wx:key="emotionIndex" wx:for-item="emotion" wx:for-index="emotionIndex">
              <text class="emotion-emoji-small">{{emotion.emoji}}</text>
              <text class="emotion-label-small">{{emotion.label}}</text>
            </view>
          </view>
        </view>
        <view class="record-text" wx:if="{{item.text}}">{{item.text}}</view>
        <view class="record-detail-hint">点击查看详情 →</view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{records.length === 0}}">
      <text class="empty-text">还没有记录</text>
      <text class="empty-hint">记录你的情绪，更好地了解自己</text>
    </view>
  </view>

  <view class="history-footer">
    <button class="back-btn" bindtap="backTap">返回首页</button>
  </view>

  <!-- 编辑弹窗 -->
  <view class="edit-mask" wx:if="{{editingIndex >= 0}}">
    <view class="edit-dialog">
      <view class="edit-title">编辑记录</view>
      <textarea
        class="edit-textarea"
        value="{{editingText}}"
        bindinput="onEditingInput"
        maxlength="500"
      ></textarea>
      <view class="edit-actions">
        <button class="edit-btn cancel" bindtap="cancelEdit">取消</button>
        <button class="edit-btn confirm" bindtap="saveEdit">保存</button>
      </view>
    </view>
  </view>
</view>

